rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Regras para a coleção de usuários
    match /users/{userId} {
      // Apenas o próprio usuário pode ler/escrever seus dados e configurações (metas de macros)
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Regras para a subcoleção food_logs
      match /food_logs/{document} {
        // Apenas o usuário autenticado pode ler/escrever seus próprios logs
        allow read, write: if request.auth != null && request.auth.uid == userId;
        
        // Validação dos dados ao criar/atualizar
        allow create, update: if request.auth != null 
          && request.auth.uid == userId
          && request.resource.data.keys().hasAll(['name', 'calories', 'date'])
          && request.resource.data.name is string
          && request.resource.data.name.size() > 0
          && request.resource.data.name.size() <= 200
          && request.resource.data.calories is int
          && request.resource.data.calories > 0
          && request.resource.data.calories <= 10000
          && request.resource.data.date is timestamp;
      }
    }
    
    // Bloquear acesso a qualquer outra coleção
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
